# Climate Safe Cities: Climate Vulnerability Index Development
# Creates comprehensive vulnerability scores for cities using multiple data sources

library(tidyverse)
library(lubridate)
library(corrplot)
source("99_utilities/helper_functions.R")

# ======================================================================
# DATA LOADING FUNCTIONS
# ======================================================================

# Load all city data for vulnerability analysis
load_all_city_data <- function() {
  print_header("LOADING ALL CITY DATA FOR ANALYSIS")
  
  cities_dir <- "data/cities"
  city_folders <- list.dirs(cities_dir, full.names = FALSE, recursive = FALSE)
  city_folders <- city_folders[city_folders != ""]
  
  all_data <- list()
  
  for (city_folder in city_folders) {
    city_name <- str_to_title(str_replace_all(city_folder, "_", " "))
    cat("📊 Loading data for", city_name, "...\n")
    
    city_data <- list()
    city_path <- file.path(cities_dir, city_folder)
    
    # Load weather data
    weather_file <- file.path(city_path, "weather_data_nasa.csv")
    if (file.exists(weather_file)) {
      city_data$weather <- read_csv(weather_file, show_col_types = FALSE) %>%
        mutate(city_name = city_name)
    }
    
    # Load climate data (prioritize fixed version)
    climate_file_fixed <- file.path(city_path, "country_climate_data_fixed.csv")
    climate_file_original <- file.path(city_path, "country_climate_data.csv")
    
    if (file.exists(climate_file_fixed)) {
      city_data$climate <- read_csv(climate_file_fixed, show_col_types = FALSE) %>%
        mutate(city_name = city_name)
    } else if (file.exists(climate_file_original)) {
      # Convert wide to long format if needed
      climate_wide <- read_csv(climate_file_original, show_col_types = FALSE)
      indicator_cols <- colnames(climate_wide)[grepl("^[A-Z]{2}\\.[A-Z]{2,3}\\.", colnames(climate_wide))]
      if (length(indicator_cols) > 0) {
        city_data$climate <- climate_wide %>%
          select(iso2c, iso3c, country, date, all_of(indicator_cols)) %>%
          pivot_longer(cols = all_of(indicator_cols), names_to = "indicator_id", values_to = "value") %>%
          filter(!is.na(value)) %>%
          mutate(city_name = city_name)
      }
    }
    
    # Load economic data (prioritize fixed version)
    economic_file_fixed <- file.path(city_path, "economic_gender_data_fixed.csv")
    economic_file_original <- file.path(city_path, "economic_gender_data.csv")
    
    if (file.exists(economic_file_fixed)) {
      city_data$economic <- read_csv(economic_file_fixed, show_col_types = FALSE) %>%
        mutate(city_name = city_name)
    } else if (file.exists(economic_file_original)) {
      # Convert wide to long format if needed
      economic_wide <- read_csv(economic_file_original, show_col_types = FALSE)
      indicator_cols <- colnames(economic_wide)[grepl("^[A-Z]{2}\\.[A-Z]{2,3}\\.", colnames(economic_wide))]
      if (length(indicator_cols) > 0) {
        city_data$economic <- economic_wide %>%
          select(iso2c, iso3c, country, date, all_of(indicator_cols)) %>%
          pivot_longer(cols = all_of(indicator_cols), names_to = "indicator_id", values_to = "value") %>%
          filter(!is.na(value)) %>%
          mutate(city_name = city_name) %>%
          mutate(indicator_category = case_when(
            str_starts(indicator_id, "NY.GDP") ~ "Economic",
            str_starts(indicator_id, "NV.") ~ "Economic",
            str_starts(indicator_id, "SL.") ~ "Employment",
            str_starts(indicator_id, "SE.") ~ "Education",
            str_starts(indicator_id, "SH.") | str_starts(indicator_id, "SP.") ~ "Health",
            str_starts(indicator_id, "SG.") ~ "Rights",
            TRUE ~ "Other"
          ))
      }
    }
    
    # Load social data
    social_file <- file.path(city_path, "social_vulnerability_data.csv")
    if (file.exists(social_file)) {
      city_data$social <- read_csv(social_file, show_col_types = FALSE) %>%
        mutate(city_name = city_name)
    }
    
    all_data[[city_name]] <- city_data
    cat("✅", city_name, "data loaded\n")
  }
  
  cat("\n📋 Data loading complete for", length(all_data), "cities\n")
  return(all_data)
}

# ======================================================================
# CLIMATE RISK INDICATORS
# ======================================================================

# Calculate temperature-related climate risks
calculate_temperature_risk <- function(weather_data, city_name) {
  if (is.null(weather_data) || nrow(weather_data) == 0) {
    return(tibble(city_name = city_name, temp_risk_score = NA))
  }
  
  # Define climate-specific thresholds
  # (These could be made more sophisticated based on city location)
  risk_metrics <- weather_data %>%
    mutate(
      year = year(date),
      # Heat risk indicators
      extreme_heat_day = temp_max_c > 35,  # Adjust for local climate
      heat_wave_day = temp_max_c > 30,     # Milder heat stress
      cold_extreme_day = temp_min_c < 0,   # Freezing temperatures
      # Temperature variability
      daily_temp_range = temp_max_c - temp_min_c
    ) %>%
    group_by(city_name, year) %>%
    summarise(
      # Heat indicators
      avg_temp_max = mean(temp_max_c, na.rm = TRUE),
      extreme_heat_days = sum(extreme_heat_day, na.rm = TRUE),
      heat_wave_days = sum(heat_wave_day, na.rm = TRUE),
      max_temp_recorded = max(temp_max_c, na.rm = TRUE),
      
      # Cold indicators  
      cold_extreme_days = sum(cold_extreme_day, na.rm = TRUE),
      min_temp_recorded = min(temp_min_c, na.rm = TRUE),
      
      # Variability indicators
      temp_variability = sd(temp_avg_c, na.rm = TRUE),
      avg_daily_range = mean(daily_temp_range, na.rm = TRUE),
      
      .groups = "drop"
    ) %>%
    group_by(city_name) %>%
    summarise(
      # Multi-year temperature risk indicators
      avg_annual_max_temp = mean(avg_temp_max, na.rm = TRUE),
      avg_extreme_heat_days = mean(extreme_heat_days, na.rm = TRUE),
      avg_heat_wave_days = mean(heat_wave_days, na.rm = TRUE),
      record_max_temp = max(max_temp_recorded, na.rm = TRUE),
      avg_cold_extreme_days = mean(cold_extreme_days, na.rm = TRUE),
      record_min_temp = min(min_temp_recorded, na.rm = TRUE),
      avg_temp_variability = mean(temp_variability, na.rm = TRUE),
      
      # Temperature trends (simple linear)
      temp_trend = if(n() > 2) {
        lm(avg_temp_max ~ year, data = pick(everything()))$coefficients[2]
      } else { 0 },
      
      .groups = "drop"
    )
  
  # Calculate composite temperature risk score (0-1 scale)
  risk_metrics %>%
    mutate(
      # Normalize risk factors (higher = more risk)
      heat_risk = pmin(1, (avg_extreme_heat_days + avg_heat_wave_days/2) / 50),
      cold_risk = pmin(1, avg_cold_extreme_days / 100),
      variability_risk = pmin(1, avg_temp_variability / 10),
      trend_risk = pmax(0, pmin(1, temp_trend * 10)),  # Warming trend as risk
      
      # Composite score (weighted average)
      temp_risk_score = (heat_risk * 0.4 + cold_risk * 0.2 + variability_risk * 0.2 + trend_risk * 0.2)
    ) %>%
    select(city_name, temp_risk_score, avg_annual_max_temp, avg_extreme_heat_days, 
           avg_temp_variability, temp_trend)
}

# Calculate precipitation-related climate risks
calculate_precipitation_risk <- function(weather_data, city_name) {
  if (is.null(weather_data) || nrow(weather_data) == 0) {
    return(tibble(city_name = city_name, precip_risk_score = NA))
  }
  
  risk_metrics <- weather_data %>%
    mutate(
      year = year(date),
      # Precipitation risk indicators
      extreme_precip_day = precipitation_mm > 25,    # Heavy rainfall
      very_extreme_precip = precipitation_mm > 50,   # Very heavy rainfall
      drought_day = precipitation_mm == 0,           # No precipitation
      # Monthly and seasonal patterns
      month = month(date)
    ) %>%
    group_by(city_name, year) %>%
    summarise(
      # Annual precipitation indicators
      total_annual_precip = sum(precipitation_mm, na.rm = TRUE),
      extreme_precip_days = sum(extreme_precip_day, na.rm = TRUE),
      very_extreme_days = sum(very_extreme_precip, na.rm = TRUE),
      drought_days = sum(drought_day, na.rm = TRUE),
      max_daily_precip = max(precipitation_mm, na.rm = TRUE),
      
      # Variability indicators
      precip_variability = sd(precipitation_mm, na.rm = TRUE),
      
      .groups = "drop"
    ) %>%
    group_by(city_name) %>%
    summarise(
      # Multi-year precipitation risk indicators
      avg_annual_precip = mean(total_annual_precip, na.rm = TRUE),
      avg_extreme_precip_days = mean(extreme_precip_days, na.rm = TRUE),
      avg_very_extreme_days = mean(very_extreme_days, na.rm = TRUE),
      avg_drought_days = mean(drought_days, na.rm = TRUE),
      record_daily_precip = max(max_daily_precip, na.rm = TRUE),
      avg_precip_variability = mean(precip_variability, na.rm = TRUE),
      
      # Precipitation trends
      precip_trend = if(n() > 2) {
        lm(total_annual_precip ~ year, data = pick(everything()))$coefficients[2]
      } else { 0 },
      
      .groups = "drop"
    )
  
  # Calculate composite precipitation risk score
  risk_metrics %>%
    mutate(
      # Normalize risk factors
      flood_risk = pmin(1, (avg_extreme_precip_days + avg_very_extreme_days) / 30),
      drought_risk = pmin(1, avg_drought_days / 200),
      variability_risk = pmin(1, avg_precip_variability / 20),
      extreme_event_risk = pmin(1, record_daily_precip / 100),
      
      # Composite score
      precip_risk_score = (flood_risk * 0.3 + drought_risk * 0.3 + 
                             variability_risk * 0.2 + extreme_event_risk * 0.2)
    ) %>%
    select(city_name, precip_risk_score, avg_annual_precip, avg_extreme_precip_days,
           avg_drought_days, record_daily_precip)
}

# ======================================================================
# ADAPTIVE CAPACITY INDICATORS
# ======================================================================

# Calculate economic resilience from World Bank data
calculate_economic_resilience <- function(economic_data, city_name) {
  if (is.null(economic_data) || nrow(economic_data) == 0) {
    return(tibble(city_name = city_name, economic_resilience_score = NA))
  }
  
  # Get latest available values for key economic indicators
  economic_indicators <- economic_data %>%
    group_by(indicator_id) %>%
    filter(!is.na(value)) %>%
    slice_max(date, n = 1) %>%
    ungroup() %>%
    select(indicator_id, value) %>%
    pivot_wider(names_from = indicator_id, values_from = value)
  
  # Calculate economic resilience components
  resilience_metrics <- tibble(city_name = city_name)
  
  # GDP per capita (higher = more resilient)
  if ("NY.GDP.PCAP.CD" %in% colnames(economic_indicators)) {
    gdp_per_capita <- economic_indicators$NY.GDP.PCAP.CD
    resilience_metrics$gdp_per_capita <- gdp_per_capita
    # Normalize to 0-1 scale (using global ranges)
    resilience_metrics$gdp_resilience <- pmin(1, gdp_per_capita / 80000)
  } else {
    resilience_metrics$gdp_resilience <- 0.5  # Default if missing
  }
  
  # Economic diversity (services vs manufacturing balance)
  services_share <- ifelse("NV.SRV.TOTL.ZS" %in% colnames(economic_indicators), 
                           economic_indicators$NV.SRV.TOTL.ZS, 70)
  manufacturing_share <- ifelse("NV.IND.MANF.ZS" %in% colnames(economic_indicators),
                                economic_indicators$NV.IND.MANF.ZS, 15)
  
  # Diversity score (balanced economy is more resilient)
  resilience_metrics$economic_diversity <- 1 - abs(services_share - 60)/60  # Optimal around 60% services
  
  # Female labor participation (higher = more resilient)
  if ("SL.TLF.CACT.FE.ZS" %in% colnames(economic_indicators)) {
    female_labor <- economic_indicators$SL.TLF.CACT.FE.ZS
    resilience_metrics$gender_inclusion <- pmin(1, female_labor / 70)  # Normalize to 70% max
  } else {
    resilience_metrics$gender_inclusion <- 0.5
  }
  
  # Composite economic resilience score
  resilience_metrics %>%
    mutate(
      economic_resilience_score = (gdp_resilience * 0.4 + 
                                     economic_diversity * 0.3 + 
                                     gender_inclusion * 0.3)
    ) %>%
    select(city_name, economic_resilience_score, gdp_per_capita, economic_diversity, gender_inclusion)
}

# Calculate social vulnerability from various indicators
calculate_social_vulnerability <- function(social_data, economic_data, city_name) {
  vulnerability_score <- 0.5  # Default moderate vulnerability
  
  # For US cities, use census tract data
  if (!is.null(social_data) && "GEOID" %in% colnames(social_data)) {
    # Calculate average vulnerability across census tracts
    social_metrics <- social_data %>%
      summarise(
        avg_poverty = mean(poverty, na.rm = TRUE),
        avg_elderly = mean(age_65_plus, na.rm = TRUE),
        avg_no_vehicle = mean(no_vehicle, na.rm = TRUE),
        avg_limited_english = mean(limited_english, na.rm = TRUE),
        .groups = "drop"
      )
    
    # Normalize and combine (higher = more vulnerable)
    if (nrow(social_metrics) > 0) {
      vulnerability_score <- mean(c(
        pmin(1, social_metrics$avg_poverty / 1000),      # Normalize by typical tract size
        pmin(1, social_metrics$avg_elderly / 500),
        pmin(1, social_metrics$avg_no_vehicle / 300),
        pmin(1, social_metrics$avg_limited_english / 200)
      ), na.rm = TRUE)
    }
  }
  
  # For international cities, use World Bank social indicators
  if (!is.null(economic_data)) {
    # Life expectancy (higher = less vulnerable)
    life_exp_data <- economic_data %>%
      filter(indicator_id == "SP.DYN.LE00.FE.IN", !is.na(value)) %>%
      slice_max(date, n = 1)
    
    if (nrow(life_exp_data) > 0) {
      life_expectancy <- life_exp_data$value
      life_exp_score <- 1 - pmin(1, life_expectancy / 85)  # Invert: higher life exp = lower vulnerability
      vulnerability_score <- (vulnerability_score + life_exp_score) / 2
    }
  }
  
  return(tibble(
    city_name = city_name,
    social_vulnerability_score = vulnerability_score
  ))
}

# ======================================================================
# MASTER VULNERABILITY INDEX
# ======================================================================

# Calculate comprehensive vulnerability index for all cities
calculate_vulnerability_index <- function(all_city_data) {
  print_header("CALCULATING CLIMATE VULNERABILITY INDEX")
  
  vulnerability_results <- list()
  
  for (city_name in names(all_city_data)) {
    cat("🔍 Analyzing", city_name, "...\n")
    
    city_data <- all_city_data[[city_name]]
    
    # Calculate risk components
    temp_risk <- calculate_temperature_risk(city_data$weather, city_name)
    precip_risk <- calculate_precipitation_risk(city_data$weather, city_name)
    economic_resilience <- calculate_economic_resilience(city_data$economic, city_name)
    social_vulnerability <- calculate_social_vulnerability(city_data$social, city_data$economic, city_name)
    
    # Combine all components
    city_vulnerability <- temp_risk %>%
      left_join(precip_risk, by = "city_name") %>%
      left_join(economic_resilience, by = "city_name") %>%
      left_join(social_vulnerability, by = "city_name") %>%
      mutate(
        # Calculate composite scores
        climate_risk = (temp_risk_score + precip_risk_score) / 2,
        adaptive_capacity = (economic_resilience_score + (1 - social_vulnerability_score)) / 2,
        
        # Final vulnerability index
        vulnerability_index = climate_risk - adaptive_capacity + 0.5,  # Center around 0.5
        vulnerability_index = pmax(0, pmin(1, vulnerability_index)),   # Bound between 0-1
        
        # Vulnerability categories
        vulnerability_category = case_when(
          vulnerability_index >= 0.7 ~ "Very High",
          vulnerability_index >= 0.5 ~ "High",
          vulnerability_index >= 0.3 ~ "Moderate", 
          TRUE ~ "Low"
        ),
        
        # Analysis date
        analysis_date = Sys.Date()
      )
    
    vulnerability_results[[city_name]] <- city_vulnerability
    cat("✅", city_name, "vulnerability analysis complete\n")
  }
  
  # Combine all results
  final_results <- bind_rows(vulnerability_results)
  
  cat("\n📊 Vulnerability analysis complete for", nrow(final_results), "cities\n")
  return(final_results)
}

# ======================================================================
# ANALYSIS AND VISUALIZATION FUNCTIONS
# ======================================================================

# Create vulnerability index summary
create_vulnerability_summary <- function(vulnerability_data) {
  print_header("VULNERABILITY INDEX SUMMARY")
  
  # Overall statistics
  cat("📊 OVERALL STATISTICS:\n")
  cat("   Cities analyzed:", nrow(vulnerability_data), "\n")
  cat("   Average vulnerability:", round(mean(vulnerability_data$vulnerability_index, na.rm = TRUE), 3), "\n")
  cat("   Highest risk city:", vulnerability_data$city_name[which.max(vulnerability_data$vulnerability_index)], "\n")
  cat("   Lowest risk city:", vulnerability_data$city_name[which.min(vulnerability_data$vulnerability_index)], "\n\n")
  
  # Category breakdown
  cat("📋 VULNERABILITY CATEGORIES:\n")
  category_summary <- vulnerability_data %>%
    count(vulnerability_category, sort = TRUE)
  
  for (i in 1:nrow(category_summary)) {
    cat("   ", category_summary$vulnerability_category[i], ":", category_summary$n[i], "cities\n")
  }
  
  # Detailed rankings
  cat("\n🏆 VULNERABILITY RANKINGS:\n")
  rankings <- vulnerability_data %>%
    arrange(desc(vulnerability_index)) %>%
    select(city_name, vulnerability_index, vulnerability_category, climate_risk, adaptive_capacity)
  
  for (i in 1:nrow(rankings)) {
    cat(sprintf("   %d. %s (%.3f) - %s\n", 
                i, rankings$city_name[i], rankings$vulnerability_index[i], 
                rankings$vulnerability_category[i]))
  }
  
  return(rankings)
}

# Create correlation analysis
analyze_vulnerability_correlations <- function(vulnerability_data) {
  print_header("VULNERABILITY FACTOR CORRELATIONS")
  
  # Select numeric columns for correlation
  correlation_data <- vulnerability_data %>%
    select(vulnerability_index, climate_risk, adaptive_capacity, 
           temp_risk_score, precip_risk_score, economic_resilience_score, 
           social_vulnerability_score) %>%
    rename(
      "Vulnerability Index" = vulnerability_index,
      "Climate Risk" = climate_risk,
      "Adaptive Capacity" = adaptive_capacity,
      "Temperature Risk" = temp_risk_score,
      "Precipitation Risk" = precip_risk_score,
      "Economic Resilience" = economic_resilience_score,
      "Social Vulnerability" = social_vulnerability_score
    )
  
  # Calculate correlations
  cor_matrix <- cor(correlation_data, use = "complete.obs")
  
  # Print key correlations
  cat("🔗 KEY CORRELATIONS WITH VULNERABILITY INDEX:\n")
  vuln_correlations <- cor_matrix[,"Vulnerability Index"]
  vuln_correlations <- vuln_correlations[names(vuln_correlations) != "Vulnerability Index"]
  vuln_correlations <- sort(abs(vuln_correlations), decreasing = TRUE)
  
  for (i in 1:length(vuln_correlations)) {
    cat(sprintf("   %s: %.3f\n", names(vuln_correlations)[i], vuln_correlations[i]))
  }
  
  return(cor_matrix)
}

# ======================================================================
# EXPORT AND SAVE FUNCTIONS
# ======================================================================

# Save vulnerability analysis results
save_vulnerability_results <- function(vulnerability_data, correlation_matrix) {
  print_header("SAVING VULNERABILITY ANALYSIS RESULTS")
  
  # Create outputs directory
  ensure_directory("outputs")
  ensure_directory("outputs/vulnerability_analysis")
  
  # Save main results
  write_csv(vulnerability_data, "outputs/vulnerability_analysis/vulnerability_index_results.csv")
  cat("✅ Main results saved to outputs/vulnerability_analysis/vulnerability_index_results.csv\n")
  
  # Save correlation matrix
  cor_df <- as.data.frame(correlation_matrix)
  cor_df$metric <- rownames(cor_df)
  write_csv(cor_df, "outputs/vulnerability_analysis/correlation_matrix.csv")
  cat("✅ Correlation matrix saved to outputs/vulnerability_analysis/correlation_matrix.csv\n")
  
  # Create summary report
  summary_report <- vulnerability_data %>%
    arrange(desc(vulnerability_index)) %>%
    mutate(Rank = row_number()) %>%
    select(
      Rank,
      City = city_name,
      `Vulnerability Index` = vulnerability_index,
      Category = vulnerability_category,
      `Climate Risk` = climate_risk,
      `Adaptive Capacity` = adaptive_capacity,
      `Temperature Risk` = temp_risk_score,
      `Precipitation Risk` = precip_risk_score,
      `Economic Resilience` = economic_resilience_score,
      `Social Vulnerability` = social_vulnerability_score
    ) %>%
    mutate(across(where(is.numeric), ~round(.x, 3)))
  
  write_csv(summary_report, "outputs/vulnerability_analysis/vulnerability_summary_report.csv")
  cat("✅ Summary report saved to outputs/vulnerability_analysis/vulnerability_summary_report.csv\n")
  
  cat("\n📊 All vulnerability analysis results saved!\n")
}

# ======================================================================
# READY-TO-USE COMMANDS
# ======================================================================

cat("✅ Climate Vulnerability Index functions loaded!\n")
cat("🏗️ Available functions:\n")
cat("  • load_all_city_data() - Load all collected city data\n")
cat("  • calculate_vulnerability_index(all_city_data) - Calculate complete vulnerability index\n")
cat("  • create_vulnerability_summary(vulnerability_data) - Generate summary statistics\n")
cat("  • analyze_vulnerability_correlations(vulnerability_data) - Correlation analysis\n")
cat("  • save_vulnerability_results(vulnerability_data, correlations) - Save all results\n")
cat("\n🚀 Complete workflow:\n")
cat("  all_data <- load_all_city_data()\n")
cat("  vulnerability_results <- calculate_vulnerability_index(all_data)\n")
cat("  rankings <- create_vulnerability_summary(vulnerability_results)\n")
cat("  correlations <- analyze_vulnerability_correlations(vulnerability_results)\n")
cat("  save_vulnerability_results(vulnerability_results, correlations)\n")